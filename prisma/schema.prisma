// Prisma schema for Happy Backend Game System
// MongoDB provider with comprehensive game state management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
}

// Enum for user roles
enum UserRole {
  ADULT
  CHILD
}

// Enum for content restrictions
enum ContentRestriction {
  NONE
  MILD
  MODERATE
  STRICT
}

// Parent Contact Information Model
model ParentContact {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  parentName      String
  parentPhone     String
  parentEmail     String
  verificationCode String?
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relation to User (Child)
  childUsers      User[]   @relation("ChildToParent")
}

// Game Level Data - Static Configuration
model LevelData {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  levelId         Int      @unique
  levelName       String
  maxChocolates   Int      @default(30)
  maxEggs         Int      @default(20)
  totalElements   Int
  difficulty      String   @default("normal")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Main User Model
model User {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  email           String   @unique
  password        String   // Argon2 hashed
  fullName        String
  role            UserRole @default(ADULT)
  
  // Sensitive Data
  physicalAddress String?
  age             Int?
  
  // Child account linkage
  parentContactId String?  @db.ObjectId
  parentContact   ParentContact? @relation("ChildToParent", fields: [parentContactId], references: [id])
  
  // Parental Control
  isVerifiedByParent Boolean @default(true)
  playTokens      String[] @default([]) // Tokens generated by parent for child play
  
  // Account Status
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  gameProfile     GameProfile?
  sessions        UserSession[]
  activityLog     ActivityLog[]
}

// Game Profile with Game State
model GameProfile {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @unique @db.ObjectId
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Game Options
  language        String   @default("ar") // Arabic by default
  soundEnabled    Boolean  @default(true)
  musicEnabled    Boolean  @default(true)
  contentRestriction ContentRestriction @default(NONE)
  
  // Game Progression
  currentLevel    Int      @default(1)
  totalScore      Int      @default(0)
  totalPlayTime   Int      @default(0) // in seconds
  
  // Deeply nested JSON for game state
  levelsData      Json     @default("{}") // Level progress with collected items
  inventory       Json     @default("{}") // Player inventory
  missions        Json     @default("{}") // Mission tracking
  achievements    Json     @default("{}") // Achievements data
  
  // Offline state
  pendingSync     Boolean  @default(false)
  lastSyncAt      DateTime @default(now())
  lastPlayedAt    DateTime @default(now())
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// User Session Model
model UserSession {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token           String   @unique
  expiresAt       DateTime
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Activity Log for security & monitoring
model ActivityLog {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action          String   // e.g., "LOGIN", "ITEM_COLLECTED", "LEVEL_COMPLETED"
  details         Json     @default("{}")
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())
}

// WebSocket Connection Tracking
model WebSocketConnection {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  socketId        String   @unique
  connectedAt     DateTime @default(now())
  disconnectedAt  DateTime?
  lastHeartbeat   DateTime @default(now())
}
